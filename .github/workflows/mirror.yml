name: Mirror Repository

on:
  push:
    branches:
      - '**'

jobs:
  mirror:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source repository
        uses: actions/checkout@v2
        with:
          repository: ArielChambaz/Neptune
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.ref }}

      - name: Setup HTTP credentials for mirror
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git remote remove mirror || true
          git remote add mirror https://${{ secrets.GITHUB_TOKEN }}@github.com/EpitechPromo2026/G-EIP-700-REN-7-1-eip-adrien.picot.git

      - name: Remove .github directory
        run: |
          rm -rf .github

      - name: Configure Git user
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"

      - name: Clean Git environment to reduce data load
        run: |
          git reflog expire --expire=now --all
          git gc --prune=now
          git repack -a -d --depth=250 --window=250
          git fsck --full

      - name: Push commits only to mirror (HTTP)
        run: |
          git push mirror main --force --no-thin

      - name: Push tags separately to mirror (HTTP)
        run: |
          git push mirror --tags --force

      - name: Debug - Show Git status
        run: |
          git status

      - name: Debug - Show Git log
        run: |
          git log -3
